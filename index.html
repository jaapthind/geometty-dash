<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ICE AGE: THE BOARD GAME</title>
    <style>
        /* ==========================================================================
           1. STRICT IFRAME/GITHUB PAGES LAYOUT ENGINE (Zero Scroll Guarantee)
           ========================================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Carter+One&family=Nunito:wght@400;700;900&display=swap');

        :root {
            --gold: #FFC107; --cyan: #00E5FF; --red: #FF1744; --green: #00E676; --purple: #D500F9;
            --glass-bg: rgba(20, 25, 30, 0.85); 
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        /* CRITICAL SIZING FIX: 
           Using 100% instead of 100vh prevents Google Sites iframes from cutting off the bottom. 
           Absolute positioning locks the game to the exact pixel bounds of the window.
        */
        html, body { 
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; 
            box-sizing: border-box; touch-action: none; font-family: 'Nunito', sans-serif; 
            background: #0d1321; color: #FFF; position: absolute; inset: 0;
        }

        * { box-sizing: inherit; user-select: none; -webkit-tap-highlight-color: transparent; }

        /* Smooth background for performance */
        #bg-canvas { 
            position: absolute; inset: 0; z-index: -10; 
            background: radial-gradient(circle at center, #003a5c 0%, #0d1321 100%); 
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.5); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--cyan); border-radius: 10px; }

        .glass-panel { 
            background: var(--glass-bg); border: 1px solid var(--glass-border); 
            border-radius: 1.5vmin; position: relative; overflow: hidden; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }

        /* ==========================================================================
           2. SETUP SCREEN (Perfectly Centered & Scaled)
           ========================================================================== */
        #setup-container { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; transition: opacity 0.3s ease; padding: 2vmin; background: rgba(13, 19, 33, 0.98); }
        #setup-screen { width: 100%; max-width: 650px; padding: 4vmin; text-align: center; display: flex; flex-direction: column; gap: 2vmin; border: 2px solid var(--cyan); }
        
        .title-text { color: var(--cyan); font-size: clamp(2.5rem, 8vmin, 5rem); margin: 0; font-family: 'Carter One'; text-shadow: 2px 2px 0px #000; }
        .subtitle-text { color: var(--gold); font-size: clamp(1.2rem, 3.5vmin, 2rem); margin: 0 0 2vmin 0; letter-spacing: 0.5vmin; text-transform: uppercase;}

        .setup-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.6); padding: 1.5vmin; border-radius: 1vmin; border: 1px solid var(--glass-border); }
        .setup-row input { font-size: clamp(1rem, 2.5vmin, 1.5rem); padding: 1vmin; width: 70%; background: #000; color: #FFF; border: 1px solid var(--cyan); border-radius: 0.5vmin; font-weight: bold; outline: none; text-align: center;}
        .player-color-dot { width: 4vmin; height: 4vmin; border-radius: 50%; border: 2px solid #FFF; }

        .btn { background: var(--gold); border: 2px solid #FFF; padding: 1.5vmin 3vmin; font-size: clamp(1rem, 3vmin, 1.5rem); font-family: 'Carter One'; cursor: pointer; border-radius: 1vmin; color: #000; text-transform: uppercase; transition: transform 0.1s; width: 100%; will-change: transform; }
        .btn:active { transform: scale(0.95); }
        .btn-cyan { background: var(--cyan); }
        .btn-red { background: var(--red); color: white; }
        select.btn { text-align: center; appearance: none; background: #222; color: #FFF; border-color: var(--cyan);}

        /* ==========================================================================
           3. MASTER GAME LAYOUT (Fluid Flexbox for Landscape/Portrait)
           ========================================================================== */
        #game-interface { display: none; width: 100%; height: 100%; padding: 1vmin; gap: 1vmin; position: absolute; inset: 0;}
        
        /* Landscape Mode (PC/Tablets) */
        @media (min-aspect-ratio: 1/1) {
            #game-interface { flex-direction: row; }
            #left-col { flex: 1; display: flex; align-items: center; justify-content: center; min-width: 0; min-height: 0; padding: 1vmin;}
            #right-col { flex: 0 0 450px; max-width: 45vw; display: flex; flex-direction: column; gap: 1vmin; height: 100%; min-height: 0; }
            #hud { height: 45%; overflow-y: auto; flex-direction: column; }
            #controls { height: 55%; }
        }
        /* Portrait Mode (Mobile) */
        @media (max-aspect-ratio: 1/1) {
            #game-interface { flex-direction: column; }
            #left-col { flex: 0 0 55%; display: flex; justify-content: center; align-items: center; width: 100%; min-height: 0; padding: 1vmin;}
            #right-col { flex: 1; display: flex; flex-direction: column; gap: 1vmin; width: 100%; min-height: 0; }
            #hud { height: 40%; flex-direction: row; flex-wrap: wrap; overflow-y: auto; }
            #controls { height: 60%; }
        }

        /* HUD STYLES */
        #hud { display: flex; gap: 1vmin; width: 100%; }
        .hud-player { flex: 1; min-width: 45%; padding: 1.5vmin; text-align: center; border-radius: 1vmin; display: flex; flex-direction: column; justify-content: center; border-top: 4px solid; background: rgba(0,0,0,0.6);}
        .hud-player.active { background: rgba(255, 193, 7, 0.15) !important; border: 2px solid var(--gold); }
        .hud-player.eliminated { opacity: 0.3; filter: grayscale(1); }
        .p-name { font-size: clamp(1rem, 2.5vmin, 1.4rem); font-weight: bold; text-transform: uppercase; } 
        .p-acorns { font-size: clamp(1.8rem, 5vmin, 3rem); color: var(--gold); font-family: 'Carter One'; display: flex; align-items: center; justify-content: center; gap: 0.5vmin; margin: 0.5vmin 0; }
        
        /* CONTROLS STYLES */
        #controls { display: flex; flex-direction: column; padding: 1.5vmin; align-items: center; background: rgba(0,0,0,0.8); }
        #turn-indicator { font-size: clamp(1.5rem, 3.5vmin, 2.5rem); margin-bottom: 1vmin; font-family: 'Carter One'; text-align: center; }
        .control-buttons { display: flex; gap: 1vmin; width: 100%; margin-bottom: 1vmin; }
        #log { color: #00E676; width: 100%; flex: 1; padding: 1vmin; overflow-y: auto; font-family: monospace; font-size: clamp(0.9rem, 2vmin, 1.2rem); background: #000; border: 1px solid rgba(255,255,255,0.2); border-radius: 1vmin;}
        .log-entry { border-bottom: 1px dotted rgba(255,255,255,0.2); padding: 0.8vmin 0; }

        /* ==========================================================================
           4. RESPONSIVE GAME BOARD (Perfect Square)
           ========================================================================== */
        #board-wrapper { 
            position: relative; width: 100%; height: 100%; 
            max-width: 100vh; max-height: 100vw; 
            aspect-ratio: 1/1; display: flex; justify-content: center; align-items: center; 
        }
        
        #board { 
            display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(10, 1fr); 
            gap: 2px; width: 100%; height: 100%; padding: 4px; position: absolute; 
            background: rgba(0,0,0,0.4); border-radius: 1.5vmin; border: 2px solid var(--glass-border);
        }

        #center-island { grid-column: 2 / 10; grid-row: 2 / 10; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; border-radius: 1vmin; overflow: hidden; border: 2px solid rgba(255,255,255,0.2); }
        .biome { display: flex; align-items: center; justify-content: center; font-family: 'Carter One'; font-size: clamp(1rem, 3vmin, 3rem); color: #FFF; text-align: center; z-index: 1; padding: 2%; line-height: 1.1; }
        .b-grass { background: #1b5e20; } .b-mtn { background: #37474f; } .b-vill { background: #4e342e; } .b-snow { background: #01579b; }

        .space { 
            background: #FFF; border: 1px solid #000; border-radius: 4px; color: #000; font-weight: 900; 
            font-size: clamp(0.4rem, 1.5vmin, 0.9rem); display: flex; flex-direction: column; align-items: center; 
            justify-content: center; text-align: center; padding: 1px; position: relative; line-height: 1; 
        }
        .space.glow { border: 2px solid var(--gold); background: #fffde7; }
        
        .s-start { background: var(--gold); font-family: 'Carter One'; font-size: clamp(0.7rem, 1.8vmin, 1.2rem); }
        .s-jaap { background: var(--red); color: #FFF; border-radius: 50%; aspect-ratio: 1/1;}
        .s-event { color: var(--red); font-size: clamp(1.2rem, 3vmin, 2.5rem); font-family: 'Carter One'; }
        .s-cyan { background: var(--cyan); }
        .s-end { background: var(--red); font-family: 'Carter One'; color: #FFF; }

        .token-container { display: flex; flex-wrap: wrap; gap: 1px; justify-content: center; position: absolute; bottom: 2px; width: 100%; z-index: 20; }
        .token { 
            width: clamp(12px, 3vmin, 28px); height: clamp(12px, 3vmin, 28px); border-radius: 50%; 
            border: 2px solid #FFF; color: #FFF; font-weight: bold; display: flex; align-items: center; 
            justify-content: center; font-size: clamp(0.5rem, 1.5vmin, 1rem); z-index: 100; 
            will-change: transform; transition: transform 0.2s linear; box-shadow: 0 2px 5px rgba(0,0,0,0.8);
        }

        /* ==========================================================================
           5. ACTION BANNER & OVERLAYS
           ========================================================================== */
        /* ACTION BANNER - The fix for events not showing properly */
        #action-banner {
            position: fixed; top: 50%; left: 0; width: 100%; transform: translateY(-50%) scaleY(0); 
            background: rgba(0,0,0,0.95); border-top: 4px solid var(--gold); border-bottom: 4px solid var(--gold); 
            color: #FFF; text-align: center; padding: 4vmin; z-index: 999999; 
            font-family: 'Carter One'; font-size: clamp(2rem, 6vmin, 5rem); 
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        #action-banner.active { transform: translateY(-50%) scaleY(1); }
        #action-desc { font-family: 'Nunito'; font-size: clamp(1rem, 3vmin, 2rem); color: var(--cyan); margin-top: 1vmin;}

        /* 3D DICE */
        #dice-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 99999; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.2s; }
        #dice-overlay.active { opacity: 1; pointer-events: all; }

        .scene { width: 25vmin; height: 25vmin; perspective: 1000px; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1); will-change: transform; }
        .cube-face { position: absolute; width: 100%; height: 100%; background: #FFF; border: 4px solid var(--gold); border-radius: 1vmin; display: flex; align-items: center; justify-content: center; font-family: 'Carter One'; font-size: 10vmin; color: #000; backface-visibility: hidden; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);}
        
        .cube-face-1 { transform: rotateY(  0deg) translateZ(12.5vmin); } .cube-face-2 { transform: rotateY( 90deg) translateZ(12.5vmin); } .cube-face-3 { transform: rotateY(180deg) translateZ(12.5vmin); } .cube-face-4 { transform: rotateY(-90deg) translateZ(12.5vmin); } .cube-face-5 { transform: rotateX( 90deg) translateZ(12.5vmin); } .cube-face-6 { transform: rotateX(-90deg) translateZ(12.5vmin); }

        /* MODALS */
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 99999; opacity: 0; pointer-events: none; transition: 0.2s; padding: 2vmin; }
        #modal-overlay.active { opacity: 1; pointer-events: all; }
        
        .modal { padding: 4vmin; text-align: center; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; transform: scale(0.9); opacity: 0; transition: 0.2s; background: #111; border: 2px solid var(--cyan); border-radius: 1vmin; }
        #modal-overlay.active .modal { transform: scale(1); opacity: 1; }
        
        .modal h2 { font-size: clamp(1.8rem, 5vmin, 3rem); color: var(--gold); margin: 0 0 2vmin 0; font-family: 'Carter One'; }
        .modal p { font-size: clamp(1rem, 2.5vmin, 1.5rem); margin-bottom: 3vmin; }
        .modal-btns { display: flex; gap: 1.5vmin; justify-content: center; flex-wrap: wrap; }

        /* PARTICLES */
        #particle-layer { position: fixed; inset: 0; pointer-events: none; z-index: 100000; overflow: hidden; perspective: 1000px; }
        .acorn-3d { position: absolute; font-size: 8vmin; top:0; left:0; will-change: transform, opacity; z-index: 999999; pointer-events: none; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.8));}
        .confetti { position: absolute; top:0; left:0; width: 1.5vmin; height: 1.5vmin; z-index: 999999; pointer-events: none; will-change: transform; }
    </style>
</head>
<body>

    <div id="bg-canvas"></div>
    <div id="particle-layer"></div>

    <div id="action-banner">
        <div id="action-title">ACTION!</div>
        <div id="action-desc">Description of action</div>
    </div>

    <div id="dice-overlay">
        <div class="scene">
            <div class="cube" id="cube">
                <div class="cube-face cube-face-1">1</div><div class="cube-face cube-face-2">2</div><div class="cube-face cube-face-3">3</div>
                <div class="cube-face cube-face-4">4</div><div class="cube-face cube-face-5">5</div><div class="cube-face cube-face-6">6</div>
            </div>
        </div>
    </div>

    <div id="setup-container">
        <div id="setup-screen" class="glass-panel">
            <h1 class="title-text">ICE AGE</h1>
            <h2 class="subtitle-text">THE BOARD GAME</h2>
            
            <select id="player-count" class="btn">
                <option value="2">2 Explorers (Duel Mode)</option>
                <option value="3">3 Explorers</option>
                <option value="4" selected>4 Explorers</option>
            </select>
            
            <div id="player-inputs"></div>
            <button id="btn-start-game" class="btn" style="margin-top: 2vmin;">Deploy Explorers</button>
        </div>
    </div>

    <div id="game-interface">
        <div id="left-col">
            <div id="board-wrapper">
                <div id="board">
                    <div id="center-island">
                        <div class="biome b-grass">GRASSY PLAINS</div>
                        <div class="biome b-mtn">MOUNTAINS</div>
                        <div class="biome b-vill">VILLAGE</div>
                        <div class="biome b-snow">SNOWY TUNDRA</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="right-col">
            <div id="hud"></div>
            <div id="controls" class="glass-panel">
                <div id="turn-indicator">Player's Turn</div>
                <div class="control-buttons">
                    <button id="btn-roll" class="btn" style="flex: 2; font-size: clamp(1.8rem, 4vmin, 2.5rem);">ROLL üé≤</button>
                </div>
                <div class="control-buttons">
                    <button id="btn-rules" class="btn btn-cyan" style="flex: 1; font-size: clamp(1rem, 2vmin, 1.2rem);">RULES</button>
                </div>
                <div id="log"></div>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal" id="modal-box">
            <h2 id="modal-title">System Alert</h2>
            <div id="modal-content-area"><div id="modal-desc">Description</div></div>
            <div id="modal-btns" class="modal-btns"></div>
        </div>
    </div>

<script>
    /* =========================================================================
       MODULE 1: AUDIO ENGINE
       ========================================================================= */
    const AudioEngine = {
        ctx: new (window.AudioContext || window.webkitAudioContext)(),
        playTone: function(freq, type, duration, volMod=1) {
            try {
                let osc = this.ctx.createOscillator(); let gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.8 * volMod, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            } catch(e) {}
        },
        sfxCoin: function() { this.playTone(800, 'square', 0.1, 0.3); setTimeout(() => this.playTone(1200, 'square', 0.15, 0.3), 50); },
        sfxLose: function() { this.playTone(200, 'sawtooth', 0.2, 0.4); },
        sfxJump: function() { this.playTone(400, 'sine', 0.1, 0.2); },
        sfxHurt: function() { this.playTone(100, 'square', 0.3, 0.5); },
        sfxDiceTick: function() { this.playTone(900, 'triangle', 0.05, 0.1); },
        sfxWin: function() { this.playTone(400, 'square', 0.2, 0.5); setTimeout(() => this.playTone(500, 'square', 0.2, 0.5), 200); setTimeout(() => this.playTone(600, 'square', 0.4, 0.5), 400); }
    };

    /* =========================================================================
       MODULE 2: GPU-ACCELERATED FX ENGINE
       ========================================================================= */
    const FX = {
        layer: document.getElementById('particle-layer'),
        
        shootConfetti: function() {
            const colors = ['#FFC107', '#00E5FF', '#FF1744', '#00E676', '#FFFFFF'];
            let ww = window.innerWidth; let wh = window.innerHeight;

            for(let i=0; i<60; i++) {
                let c = document.createElement('div'); c.className = 'confetti';
                c.style.background = colors[Math.floor(Math.random() * colors.length)];
                let startX = Math.random() * ww;
                c.style.transform = `translate3d(${startX}px, -20px, 0)`;
                c.style.transition = `transform ${Math.random()*2 + 2}s linear, opacity 1s`;
                this.layer.appendChild(c);
                
                requestAnimationFrame(() => {
                    c.style.transform = `translate3d(${startX}px, ${wh + 20}px, 0) rotate(${Math.random()*720}deg)`;
                });
                setTimeout(() => c.remove(), 4000);
            }
        },
        
        spawn3DAcorn: function(playerId, type) {
            if(type==='gain') AudioEngine.sfxCoin(); else AudioEngine.sfxLose();

            let el = document.getElementById(`tok-${playerId}`) || document.getElementById(`hud-p${playerId}`); if(!el) return;
            let rect = el.getBoundingClientRect(); 
            let acorn = document.createElement('div'); acorn.className = 'acorn-3d'; acorn.innerText = 'üå∞';
            
            let startY = rect.top; let endY = type === 'gain' ? startY - 200 : startY + window.innerHeight;
            
            acorn.style.transform = `translate3d(${rect.left}px, ${startY}px, 0) scale(0.5)`;
            acorn.style.transition = type === 'gain' ? 'transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.8s' : 'transform 1s ease-in, opacity 1s';
            if(type==='lose') acorn.style.filter = 'grayscale(1)';
            
            this.layer.appendChild(acorn);
            
            requestAnimationFrame(() => {
                acorn.style.transform = `translate3d(${rect.left}px, ${endY}px, 0) scale(2) rotate(${type==='gain'?360:-180}deg)`;
                acorn.style.opacity = '0';
            });
            setTimeout(() => acorn.remove(), 1000);
        },

        rollCenter3DDice: function(finalNumber, callback) {
            let overlay = document.getElementById('dice-overlay'); let cube = document.getElementById('cube');
            document.getElementById('btn-roll').disabled = true; overlay.classList.add('active');
            
            let xSpin = (Math.floor(Math.random() * 2) + 3) * 360; let ySpin = (Math.floor(Math.random() * 2) + 3) * 360;
            let xTarget = 0, yTarget = 0;
            switch(finalNumber) {
                case 1: xTarget = 0; yTarget = 0; break; case 2: xTarget = 0; yTarget = -90; break; case 3: xTarget = 0; yTarget = -180; break;
                case 4: xTarget = 0; yTarget = 90; break; case 5: xTarget = -90; yTarget = 0; break; case 6: xTarget = 90; yTarget = 0; break;
            }

            cube.style.transform = `rotateX(${xSpin + xTarget}deg) rotateY(${ySpin + yTarget}deg)`;
            let ticks = 0; let tickInt = setInterval(() => { AudioEngine.sfxDiceTick(); ticks++; if(ticks>8) clearInterval(tickInt); }, 150);

            setTimeout(() => {
                AudioEngine.sfxWin();
                setTimeout(() => {
                    overlay.classList.remove('active');
                    setTimeout(() => { cube.style.transition = 'none'; cube.style.transform = `rotateX(0deg) rotateY(0deg)`; void cube.offsetWidth; cube.style.transition = 'transform 1.5s cubic-bezier(0.25, 1, 0.5, 1)'; }, 200);
                    callback();
                }, 600);
            }, 1500);
        },

        // NEW: Action Banner Engine
        showActionBanner: function(title, desc, color, callback) {
            let banner = document.getElementById('action-banner');
            document.getElementById('action-title').innerText = title;
            document.getElementById('action-title').style.color = color;
            document.getElementById('action-desc').innerText = desc;
            
            banner.classList.add('active');
            
            // Wait for user to read, then dismiss and execute action
            setTimeout(() => {
                banner.classList.remove('active');
                setTimeout(callback, 300); // Wait for banner to retract before firing action
            }, 1500);
        }
    };

    /* =========================================================================
       MODULE 3: PURE BOARD MATRIX & RULES DATA (No Personalization)
       ========================================================================= */
    const gridMap = [
        {c:1, r:1}, {c:2, r:1}, {c:3, r:1}, {c:4, r:1}, {c:5, r:1}, {c:6, r:1}, {c:7, r:1}, {c:8, r:1}, {c:9, r:1}, {c:10, r:1}, 
        {c:10, r:2}, {c:10, r:3}, {c:10, r:4}, {c:10, r:5}, {c:10, r:6}, {c:10, r:7}, {c:10, r:8}, {c:10, r:9}, 
        {c:10, r:10}, {c:9, r:10}, {c:8, r:10}, {c:7, r:10}, {c:6, r:10}, {c:5, r:10}, {c:4, r:10}, {c:3, r:10}, {c:2, r:10}, {c:1, r:10}, 
        {c:1, r:9}, {c:1, r:8}, {c:1, r:7}, {c:1, r:6}, {c:1, r:5}, {c:1, r:4}, {c:1, r:3}, {c:1, r:2} 
    ];

    const SpaceData = [
        { t: "START", class: "s-start" }, { t: "+1 üå∞", f: (p) => addAcorns(p, 1) }, { t: "?", class: "s-event" },
        { t: "Ally", wait: true, f: (p) => showAllyMenu(p) }, { t: "Go Start", wait: true, f: (p) => movePlayer(p, -p.pos) },
        { t: "+1 Roll", f: (p) => { p.extraTurn = true; log(`‚≠ê ${p.name} gets an extra turn!`); } }, 
        { t: "?", class: "s-event" }, { t: "?", class: "s-event" }, { t: "+3 Spaces", wait: true, f: (p) => movePlayer(p, 3) }, 
        { t: "Jaap STOP", class: "s-jaap" }, { t: "Next Free", wait: true, class: "s-cyan", f: (p) => jumpTo(p, "Free space") }, 
        { t: "?", class: "s-event" }, { t: "Next Jaap (+2üå∞)", wait: true, f: (p) => { addAcorns(p, 2); jumpTo(p, "Jaap STOP"); } }, 
        { t: "Ally", wait: true, f: (p) => showAllyMenu(p) }, { t: "?", class: "s-event" }, { t: "Jaap STOP", class: "s-jaap" }, 
        { t: "?", class: "s-event" }, { t: "+1 üå∞", f: (p) => addAcorns(p, 1) }, { t: "?", class: "s-event" }, { t: "?", class: "s-event" }, 
        { t: "Next Ally", wait: true, f: (p) => jumpTo(p, "Ally") }, { t: "Jaap STOP", class: "s-jaap" }, { t: "?", class: "s-event" }, 
        { t: "Ally", wait: true, f: (p) => showAllyMenu(p) }, { t: "Free space" }, { t: "Bridge" }, { t: "Free space" },
        { t: "-4 Spaces", wait: true, f: (p) => movePlayer(p, -4) }, { t: "-2 üå∞", f: (p) => { loseAcorns(p, 2); AudioEngine.sfxHurt(); } }, 
        { t: "Jaap STOP", class: "s-jaap" }, { t: "Trade", wait: true, f: (p) => showTradeMenu(p) }, { t: "Trade", wait: true, f: (p) => showTradeMenu(p) },
        { t: "-8 Spaces (+2üå∞)", wait: true, f: (p) => { addAcorns(p, 2); movePlayer(p, -8); } }, { t: "?", class: "s-event" },
        { t: "+1 üå∞", f: (p) => addAcorns(p, 1) }, { t: "End", class: "s-end" }
    ];

    const AlliesList = [
        { name: "Mammoth", p: "Skip Jaaps" }, { name: "Caveman", p: "+1 to Rolls" }, 
        { name: "Squirrel", p: "Start = +4 üå∞" }, { name: "Llama", p: "Lap = +2 üå∞" }, 
        { name: "White Dog", p: "Bridge = +1 üå∞" }, { name: "Leopard", p: "Free = +1 üå∞" },
        { name: "Saber-tooth", p: "Corner = +1 üå∞" }, { name: "Yak", p: "Pass = +1 üå∞" }, 
        { name: "White Wolf", p: "Defend Duels" }
    ];

    /* PUBLIC EVENT DECK (Thematic, no specific names) */
    const Events = [
        { t: "Glacier Collapse!", desc: "Everyone loses 1 üå∞.", f: (p) => { state.players.forEach(o=>{if(!o.dead) loseAcorns(o,1);}); AudioEngine.sfxHurt(); } },
        { t: "Golden Find!", desc: "Collect 2 Golden Acorns.", f: (p) => addAcorns(p, 2) }, 
        { t: "Ancient Tree!", desc: "Collect 5 Golden Acorns.", f: (p) => addAcorns(p, 5) }, 
        { t: "Villager's Gift", desc: "Gain a free Ally!", wait: true, f: (p) => showAllyMenu(p) },
        { t: "Thief in the Night", desc: "Steal 1 üå∞ from a player.", wait: true, f: (p) => showTargetMenu(p, 1) }, 
        { t: "Ice Slide", desc: "Advance directly to a Free Space.", wait: true, f: (p) => jumpTo(p, "Free space") }, 
        { t: "Lucky Find", desc: "Move 3 spaces & collect 1 üå∞.", wait: true, f: (p) => { addAcorns(p, 1); movePlayer(p, 3); } },
        { t: "Lost in the Tundra", desc: "Go back to Start.", wait: true, f: (p) => movePlayer(p, -p.pos) },
        { t: "Wandering Trader", desc: "Swap allies with another player.", wait: true, f: (p) => showSwapMenu(p) },
        { t: "Avalanche!", desc: "Move back 3 spaces.", wait: true, f: (p) => { AudioEngine.sfxHurt(); movePlayer(p, -3); } },
        { t: "Spring Thaw", desc: "Collect 1 üå∞ for every lap completed.", f: (p) => addAcorns(p, p.laps) },
        { t: "Secret Stash", desc: "Roll dice to collect acorns.", wait: true, f: (p) => { let r = Math.floor(Math.random()*6)+1; addAcorns(p, r); log(`Rolled ${r} for stash!`); nextTurn(); } },
        { t: "Shortcut!", desc: "Move straight to the Bridge.", wait: true, f: (p) => jumpTo(p, "Bridge") }
    ];

    /* =========================================================================
       MODULE 4: STATE MANAGEMENT & SETUP
       ========================================================================= */
    let state = { players: [], turn: 0, finishers: [], firstLapFinished: false };
    const colors = ['#F44336', '#4CAF50', '#2196F3', '#FFEB3B'];

    document.getElementById('player-count').addEventListener('change', (e) => {
        const c = document.getElementById('player-inputs'); c.innerHTML = '';
        for(let i=0; i<e.target.value; i++) {
            c.innerHTML += `<div class="setup-row"><input type="text" id="p${i}-name" value="Player ${i+1}" maxlength="12"><div class="player-color-dot" style="background:${colors[i]};"></div></div>`;
        }
    });
    document.getElementById('player-count').dispatchEvent(new Event('change'));

    document.getElementById('btn-start-game').addEventListener('click', () => {
        const num = document.getElementById('player-count').value;
        for(let i=0; i<num; i++) {
            state.players.push({
                id: i, name: document.getElementById(`p${i}-name`).value, color: colors[i],
                pos: 0, acorns: 4, laps: 0, ally: null, skip: false, extraTurn: false, dead: false
            });
        }
        
        const setupContainer = document.getElementById('setup-container'); setupContainer.style.opacity = '0';
        setTimeout(() => {
            setupContainer.style.display = 'none'; 
            document.getElementById('game-interface').style.display = 'flex'; 
            AudioEngine.ctx.resume(); buildBoard(); updateHUD(); setTurn();
        }, 300);
    });

    document.getElementById('btn-rules').addEventListener('click', () => {
        createChoiceModal("RULEBOOK", [{t: "Close", a: () => closeModal()}]);
        document.getElementById('modal-content-area').innerHTML = `
            <div style="text-align: left; font-size: clamp(0.9rem, 2.5vmin, 1.2rem); line-height: 1.5; color: #FFF;">
                <p><strong>Start:</strong> Distribute 4 golden acorns.</p>
                <p><strong>Laps:</strong> 1st gets +1 bonus. Everyone gets +2 per lap.</p>
                <p style="color: var(--cyan);"><strong>Endgame (3-4 P):</strong> 1st (+3üå∞), 2nd (+2üå∞), 3rd (+1üå∞). Last eliminated.</p>
                <p style="color: var(--gold);"><strong>Endgame (2 P):</strong> First to finish lap 3 gets +3üå∞. Game ends instantly. Winner based on total acorns.</p>
                <p><strong>Combat:</strong> Land on an enemy to enter Duel Arena. Winner steals 1 acorn.</p>
            </div>`;
    });

    /* =========================================================================
       MODULE 5: GAME ENGINE LOGIC & ACTION QUEUE
       ========================================================================= */
    function addAcorns(p, amt) {
        if(amt <= 0) return; p.acorns += amt;
        FX.spawn3DAcorn(p.id, 'gain'); updateHUD();
    }
    
    function loseAcorns(p, amt) {
        let actualLoss = Math.min(p.acorns, amt); if(actualLoss <= 0) return; p.acorns -= actualLoss;
        FX.spawn3DAcorn(p.id, 'lose'); updateHUD();
    }

    function buildBoard() {
        const b = document.getElementById('board'); 
        document.querySelectorAll('.space').forEach(e => e.remove());
        SpaceData.forEach((sp, i) => {
            let div = document.createElement('div'); div.className = `space ${sp.class || ''}`; div.id = `space-${i}`; div.style.gridColumn = gridMap[i].c; div.style.gridRow = gridMap[i].r;
            div.innerHTML = `<span>${sp.t}</span><div id="tc-${i}" class="token-container"></div>`; b.appendChild(div);
        });
        state.players.forEach(p => drawToken(p, false));
    }

    function drawToken(p, hopping = false) {
        if(p.dead) return;
        let old = document.getElementById(`tok-${p.id}`); if(old) old.remove();
        let tok = document.createElement('div'); tok.id = `tok-${p.id}`; tok.className = 'token';
        if (hopping) { 
            AudioEngine.sfxJump(); 
            tok.style.transition = 'transform 0.15s ease-out'; tok.style.transform = 'translateY(-3vmin) scale(1.2)';
            setTimeout(() => { tok.style.transform = 'translateY(0) scale(1)'; }, 150);
        }
        tok.style.background = p.color; tok.innerText = p.name.charAt(0);
        document.getElementById(`tc-${p.pos}`).appendChild(tok);
        
        let space = document.getElementById(`space-${p.pos}`); space.classList.add('glow');
        setTimeout(() => space.classList.remove('glow'), 800);
    }

    function updateHUD() {
        const h = document.getElementById('hud'); h.innerHTML = '';
        state.players.forEach((p, i) => {
            h.innerHTML += `<div id="hud-p${p.id}" class="hud-player ${i === state.turn ? 'active' : ''} ${p.dead ? 'eliminated' : ''}" style="border-top-color:${p.color};">
                <div class="p-name" style="color:${p.color}">${p.name}</div>
                <div class="p-acorns">${p.acorns} üå∞</div>
                <div style="font-size: clamp(0.8rem, 2vmin, 1.2rem); font-weight:bold;">Laps: <span style="color:var(--cyan);">${p.laps}/3</span></div>
                <div style="color:var(--gold); font-size: clamp(0.7rem, 1.8vmin, 1rem); font-weight:bold; margin-top:0.5vmin;">${p.ally ? p.ally.name : 'NO ALLY'}</div>
            </div>`;
        });
    }

    function log(msg) {
        const l = document.getElementById('log'); let t = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        l.innerHTML = `<div class="log-entry"><span style="color:#666;">[${t}]</span> ${msg}</div>` + l.innerHTML; l.scrollTop = 0;
    }

    function setTurn() {
        let p = state.players[state.turn]; document.getElementById('turn-indicator').innerText = `${p.name}'s Turn`;
        document.getElementById('turn-indicator').style.color = p.color; document.getElementById('btn-roll').disabled = false;
        updateHUD();
    }

    function nextTurn() {
        let p = state.players[state.turn];
        if (p.extraTurn) { p.extraTurn = false; log(`‚≠ê ${p.name} takes an extra turn!`); }
        else { do { state.turn = (state.turn + 1) % state.players.length; } while (state.players[state.turn].dead || state.finishers.includes(state.players[state.turn])); }
        setTurn();
    }

    /* =========================================================================
       MODULE 6: MOVEMENT & THE FIX FOR ACTION SPACES
       ========================================================================= */
    document.getElementById('btn-roll').addEventListener('click', () => {
        let p = state.players[state.turn];

        if (p.skip) {
            p.skip = false; log(`üõë ${p.name} skips a turn.`);
            AudioEngine.sfxHurt(); return setTimeout(nextTurn, 1000);
        }

        let baseRoll = Math.floor(Math.random() * 6) + 1;
        let bonus = (p.ally && p.ally.name === "Caveman") ? 1 : 0;
        let finalRoll = baseRoll + bonus;
        
        FX.rollCenter3DDice(finalRoll, () => {
            log(`üé≤ ${p.name} moves ${finalRoll}.`);
            movePlayer(p, finalRoll);
        });
    });

    function movePlayer(p, amt) {
        let startPos = p.pos; let steps = Math.abs(amt); let dir = amt > 0 ? 1 : -1;
        let currentStep = 0;

        function step() {
            if (currentStep >= steps) { 
                if(p.ally && p.ally.name === "Yak" && amt > 0) {
                    let passed = 0; state.players.forEach(o => { if(o.id !== p.id && !o.dead && o.pos > startPos && o.pos <= startPos+amt) passed++; });
                    if(passed > 0) { addAcorns(p, passed); log(`üêÇ Yak power: got ${passed} üå∞ passing players!`); }
                }
                evaluateSpace(p); return; 
            }
            p.pos += dir;
            
            if (p.pos >= SpaceData.length) {
                p.pos = 0; p.laps++; 
                addAcorns(p, 2); log(`üèÅ ${p.name} finished lap ${p.laps}! (+2 üå∞)`);
                
                if (!state.firstLapFinished) { state.firstLapFinished = true; addAcorns(p, 1); log(`üåü ${p.name} is FIRST to finish a lap! (+1 üå∞)`); AudioEngine.sfxWin(); }
                
                if (p.laps >= 3 && !state.finishers.includes(p)) {
                    state.finishers.push(p); let place = state.finishers.length; let totalP = state.players.length;
                    
                    if (totalP === 4) {
                        if (place === 1) { addAcorns(p, 3); log(`ü•á ${p.name} finished 1st! (+3 üå∞)`); FX.shootConfetti(); }
                        if (place === 2) { addAcorns(p, 2); log(`ü•à ${p.name} finished 2nd! (+2 üå∞)`); }
                        if (place === 3) { addAcorns(p, 1); log(`ü•â ${p.name} finished 3rd! (+1 üå∞)`); }
                        if (place === 4) { p.dead = true; log(`üíÄ ${p.name} finished LAST and is ELIMINATED!`); AudioEngine.sfxHurt(); return endGame(); }
                    } 
                    else if (totalP === 3) {
                        if (place === 1) { addAcorns(p, 2); log(`ü•á ${p.name} finished 1st! (+2 üå∞)`); FX.shootConfetti(); }
                        if (place === 2) { addAcorns(p, 1); log(`ü•à ${p.name} finished 2nd! (+1 üå∞)`); }
                        if (place === 3) { p.dead = true; log(`üíÄ ${p.name} finished LAST and is ELIMINATED!`); AudioEngine.sfxHurt(); return endGame(); }
                    } 
                    else if (totalP === 2) {
                        if (place === 1) { addAcorns(p, 3); log(`ü•á ${p.name} finished Lap 3 first! GAME OVER!`); FX.shootConfetti(); setTimeout(endGame, 1000); return; }
                    }
                }
            } else if (p.pos < 0) { p.pos = SpaceData.length - 1; }

            drawToken(p, true); currentStep++; setTimeout(step, 300); // Faster stepping
        }
        step();
    }

    function jumpTo(p, spaceName) {
        for(let i=1; i<SpaceData.length; i++) {
            if(SpaceData[(p.pos + i) % SpaceData.length].t.toLowerCase().includes(spaceName.toLowerCase())) return movePlayer(p, i);
        }
    }

    function evaluateSpace(p) {
        updateHUD(); let sp = SpaceData[p.pos]; log(`${p.name} landed on: ${sp.t}`);

        if (p.pos === 0 && p.ally && p.ally.name === "Squirrel") { addAcorns(p, 4); log("Squirrel power: +4 üå∞"); }
        if (sp.t.toLowerCase().includes("bridge") && p.ally && p.ally.name === "White Dog") { addAcorns(p, 1); log("White Dog power: +1 üå∞"); }
        if (sp.t.toLowerCase().includes("free space") && p.ally && p.ally.name === "Leopard") { addAcorns(p, 1); log("Leopard power: +1 üå∞"); }
        if (cornerSpaces.includes(p.pos) && p.ally && p.ally.name === "Saber-tooth") { addAcorns(p, 1); log("Saber-tooth power: +1 üå∞"); }

        let enemy = state.players.find(o => o.id !== p.id && !o.dead && !state.finishers.includes(o) && o.pos === p.pos);
        if (enemy) {
            if(enemy.ally && enemy.ally.name === "White Wolf") {
                log(`üê∫ White Wolf defends! ${enemy.name} steals 1 üå∞ from ${p.name}!`);
                loseAcorns(p, 1); addAcorns(enemy, 1); AudioEngine.sfxHurt(); triggerSpaceLogic(p, sp);
            } else {
                log(`‚öîÔ∏è DUEL INITIATED!`);
                openModal("‚öîÔ∏è COMBAT INITIATED ‚öîÔ∏è", ""); AudioEngine.sfxHurt();
                let content = document.getElementById('modal-content-area');
                content.innerHTML = `
                    <div class="duel-arena">
                        <div class="duel-player" id="dp1"><div class="duel-avatar" style="background:${p.color}">${p.name.charAt(0)}</div><h3 style="color:${p.color};">${p.name}</h3><div id="dd1" style="font-size: 6vmin; width: 10vmin; height: 10vmin; background:#FFF; color:#000; border-radius:1vmin; display:flex; align-items:center; justify-content:center; margin-top:1vmin;">?</div></div>
                        <div class="vs-text">VS</div>
                        <div class="duel-player" id="dp2"><div class="duel-avatar" style="background:${enemy.color}">${enemy.name.charAt(0)}</div><h3 style="color:${enemy.color};">${enemy.name}</h3><div id="dd2" style="font-size: 6vmin; width: 10vmin; height: 10vmin; background:#FFF; color:#000; border-radius:1vmin; display:flex; align-items:center; justify-content:center; margin-top:1vmin;">?</div></div>
                    </div>`;
                document.getElementById('modal-btns').innerHTML = `<button class="btn btn-red" id="btn-start-duel">ROLL</button>`;
                
                document.getElementById('btn-start-duel').onclick = () => {
                    document.getElementById('btn-start-duel').classList.add('hidden');
                    let d1 = document.getElementById('dd1'); let d2 = document.getElementById('dd2');
                    let r1=0, r2=0, ticks=0;
                    let interval = setInterval(() => {
                        r1 = Math.floor(Math.random()*6)+1; r2 = Math.floor(Math.random()*6)+1;
                        while(r1 === r2) { r1 = Math.floor(Math.random()*6)+1; r2 = Math.floor(Math.random()*6)+1; }
                        d1.innerText = r1; d2.innerText = r2; AudioEngine.sfxDiceTick(); ticks++;
                        if(ticks > 15) {
                            clearInterval(interval); let winner = r1 > r2 ? p : enemy; let loser = r1 > r2 ? enemy : p;
                            if(r1 > r2) { d1.style.color="var(--gold)"; document.getElementById('dp2').style.opacity="0.5"; } else { d2.style.color="var(--gold)"; document.getElementById('dp1').style.opacity="0.5"; }
                            AudioEngine.sfxWin();
                            document.getElementById('modal-btns').innerHTML = `<h2 style="width:100%; color:var(--gold);">${winner.name} WINS!</h2><button class="btn btn-cyan" id="btn-end-duel">Steal Acorn</button>`;
                            document.getElementById('btn-end-duel').onclick = () => { closeModal(); loseAcorns(loser, 1); addAcorns(winner, 1); log(`‚öîÔ∏è ${winner.name} stole 1 üå∞ from ${loser.name}!`); triggerSpaceLogic(p, sp); };
                        }
                    }, 80);
                };
                return;
            }
        }
        triggerSpaceLogic(p, sp);
    }

    // THE FIX: Action Banner Queue System
    function triggerSpaceLogic(p, sp) {
        if (sp.class === 's-jaap') {
            FX.showActionBanner("JAAP STOP", "Vehicle broken. Skip next turn.", var(--red), () => {
                p.skip = true; AudioEngine.sfxHurt(); nextTurn(); 
            });
        }
        else if (sp.class === 's-event') {
            let ev = Events[Math.floor(Math.random() * Events.length)];
            FX.showActionBanner("EVENT DRAWN", ev.t, var(--cyan), () => {
                createChoiceModal("EVENT DRAWN", [{t: "Resolve", a: () => { 
                    if (ev.wait) ev.f(p); 
                    else { ev.f(p); updateHUD(); nextTurn(); } 
                }}]);
                document.getElementById('modal-desc').innerHTML = `<span style="color: var(--cyan); font-size: clamp(1.2rem, 3vmin, 2rem);">${ev.desc}</span>`;
            });
        }
        else if (sp.f) { 
            // Only show banner if there is an actual action
            if(sp.t !== "START" && sp.t !== "End" && sp.t !== "Free space" && sp.t !== "Bridge") {
                 FX.showActionBanner("SPACE TRIGGERED", sp.t, var(--gold), () => {
                     sp.f(p); updateHUD(); 
                     if (!sp.wait) setTimeout(nextTurn, 500); 
                 });
            } else {
                 sp.f(p); updateHUD(); 
                 if (!sp.wait) setTimeout(nextTurn, 500);
            }
        }
        else { setTimeout(nextTurn, 800); }
    }

    /* =========================================================================
       MODULE 7: UI UTILITIES & MODALS
       ========================================================================= */
    function openModal(title, descHtml) {
        document.getElementById('modal-overlay').classList.add('active'); document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-content-area').innerHTML = `<div id="modal-desc">${descHtml}</div>`; document.getElementById('modal-btns').innerHTML = '';
    }
    function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); }
    function createChoiceModal(title, btns) {
        openModal(title, ""); let c = document.getElementById('modal-btns'); c.innerHTML = '';
        btns.forEach(b => { let btn = document.createElement('button'); btn.className = 'btn'; btn.innerText = b.t; btn.onclick = () => { closeModal(); b.a(); }; c.appendChild(btn); });
    }

    function endGame() {
        AudioEngine.sfxWin(); let rank = [...state.players].sort((a,b) => b.acorns - a.acorns); let winner = rank[0];
        openModal("üèÜ GAME OVER üèÜ", ""); FX.shootConfetti();
        
        let html = rank.map((p,i) => `
            <div style="background: rgba(0,0,0,0.8); padding: 2vmin; border-radius: 1vmin; border: 2px solid ${p.color}; margin-bottom: 2vmin; text-align: left;">
                <div style="display:flex; justify-content:space-between; font-size: clamp(1.2rem, 3vmin, 2rem); font-weight:bold; color:${p.color};">
                    <span>${i===0 ? 'üëë ' : ''}${i+1}. ${p.name}</span><span>${p.acorns} üå∞</span>
                </div>
            </div>`).join('');
        
        document.getElementById('modal-content-area').innerHTML = `<h3 style="font-size: clamp(2rem, 5vmin, 3rem); color: var(--gold); margin-bottom: 2vmin; font-family:'Carter One';">${winner.name} WINS!</h3>${html}`;
        document.getElementById('modal-btns').innerHTML = `<button class="btn btn-cyan" onclick="location.reload()">PLAY AGAIN</button>`;
        document.getElementById('btn-roll').classList.add('hidden');
    }

    function showAllyMenu(p) {
        let avail = AlliesList.filter(a => !state.players.find(pl => pl.ally && pl.ally.name === a.name));
        if(avail.length === 0) avail = AlliesList;
        let choices = avail.sort(() => 0.5 - Math.random()).slice(0, 3);
        let btns = choices.map(c => ({ t: `${c.name}\n(${c.p})`, a: () => { p.ally = c; log(`ü§ù Allied with ${c.name}`); updateHUD(); nextTurn(); } }));
        btns.push({ t: "Pass", a: () => { log("Passed on ally."); nextTurn(); } });
        createChoiceModal(`Choose Ally`, btns);
    }

    function showTradeMenu(p) {
        let btns = [
            { t: "Buy Ally (4üå∞)", a: () => { if(p.acorns>=4){ loseAcorns(p,4); showAllyMenu(p);} else {log("Not enough acorns!"); AudioEngine.sfxHurt(); nextTurn();} } },
            { t: "Sell Ally (+2üå∞)", a: () => { if(p.ally){p.ally=null; addAcorns(p,2); log("Sold ally.");} else {log("No ally to sell!");} updateHUD(); nextTurn(); } },
            { t: "Leave", a: () => nextTurn() }
        ];
        createChoiceModal("Villager Market", btns);
    }

    function showTargetMenu(p, amt) {
        let targets = state.players.filter(o => o.id !== p.id && !o.dead);
        let btns = targets.map(t => ({ t: `${t.name}`, a: () => { let act = Math.min(amt, t.acorns); loseAcorns(t, act); addAcorns(p, act); log(`Stole ${act} üå∞ from ${t.name}`); nextTurn(); } }));
        if(btns.length === 0) btns.push({t: "Nobody available", a: () => nextTurn()});
        createChoiceModal(`Steal ${amt} Acorn(s) from:`, btns);
    }

    function showSwapMenu(p) {
        let targets = state.players.filter(o => o.id !== p.id && !o.dead && o.ally);
        if(targets.length === 0) { log("Nobody has an ally to swap!"); return nextTurn(); }
        let btns = targets.map(t => ({ t: `Swap with ${t.name}`, a: () => { let temp = p.ally; p.ally = t.ally; t.ally = temp; log(`Swapped allies with ${t.name}!`); updateHUD(); nextTurn(); } }));
        btns.push({ t: "Pass", a: () => nextTurn() });
        createChoiceModal("Swap Ally", btns);
    }
</script>
</body>
</html>
